import logging

from pylons import request, response, session, tmpl_context as c, url
from pylons.controllers.util import abort, redirect
from ast import literal_eval
from gardenfreshbox.lib.base import BaseController, render
from gardenfreshbox.model.cookie import Cookie
from gardenfreshbox.model.sale import Sale
from gardenfreshbox.model.GFBDatabaseController import GFBDatabaseController as DB
import json

log = logging.getLogger(__name__)

class SalesController(BaseController):

	# used for returning success messages
	trueString = "{\"success\":\"true\"}"

	'''
	   This function accepts get and put requests
	'''
	def sales(self):
		db = DB()	

		# for all sales (regardless of host site) send hostSiteName : *
		if (request.method == "GET"):
			if request.params['hostSiteName'] == "*":
				orderList = db.getAllOrders()
				return Sale.toTableMasterOrderList(orderList)
			else:	
				orderList = db.getAllOrders()
				return Sale.toCashSaleList(orderList, request.params['hostSiteName']);
		
		# uses orderID as a key, if it is sent as "" a new order is added
		# updating orders was not implemented 
		elif (request.method == "PUT"):				
			if request.params['orderID'] == "":
				if (self.validate_new_order_inputs(request.params)):
					order = Sale(None, request.params['dateCreated'], request.params['dateToDistribute'], request.params['firstName'], request.params['lastName'], request.params['email'], request.params['phoneNumber'], request.params['shouldSendNotifications'], request.params['smallBoxQuantity'],request.params['largeBoxQuantity'], request.params['donations'], request.params['donationReceipt'], request.params['totalPaid'], request.params['hostSitePickupID'],request.params['hostSiteOrderID'],request.params['customerID'])
					success = db.createNewOrderModel(order)
					if success:
						return self.trueString
					else:
						return "{\"success\":\"false\",\"message\":\"Failed to enter new order.\"}"
				else:
					return "{\"success\":\"false\",\"message\":\"Please fix inputs.\"}"
			else:
				# order = Sale(request.params['orderID'], request.params['dateCreated'], request.params['dateToDistribute'], request.params['firstName'], request.params['lastName'], request.params['email'], request.params['phoneNumber'], request.params['shouldSendNotifications'], request.params['smallBoxQuantity'],request.params['largeBoxQuantity'], request.params['donations'], request.params['donationReceipt'], request.params['totalPaid'], request.params['hostSitePickupID'],request.params['hostSiteOrderID'])
				return "{\"success\":\"false\",\"message\":\"Failed to enter new order.\"}"

	def validate_new_order_inputs(self, params):
		isValid = True
		
		if params.orderID != "":
			isValid = False
			
		elif params.dateToDistribute == "--Select--":
			isValid = False
		
		elif params.hostSitePickupID == "--Select--":
			isValid = False
			
		elif params.smallBoxQuantity == 0 and params.largeBoxQuantity == 0 and params.donations == 0:
			isValid = False
			
		elif params.firstName == "":
			isValid = False
			
		elif params.lastName == "":
			isValid = False
			
		elif params.firstName == "":
			isValid = False
			
		
		
		return isValid

	'''
	   This method gets all orders to be sent to a given host site
	'''
	def dist(self):
		db = DB()	
		if (request.method == "GET"):
			orderList = db.getAllOrders()
			return Sale.toDistList(orderList, request.params['hostSiteName']);

	'''
	   This method gets all orders to be sent to a given  user
	'''
	def usersales(self):
		db = DB()	
		if (request.method == "GET"):
			user = db.getUser(request.params['email'])
 			orderList = db.getOrdersByUserID(user['id'])
			return  Sale.toUserSaleList(orderList)
		
	'''
	   This method gets all donations to be sent to a given  user
	'''
	def userdonations(self):
		db = DB()	
		if (request.method == "GET"):
			user = db.getUser(request.params['email'])
 			orderList = db.getDonationsByUserID(user['id'])
			return  Sale.toUserDonationList(orderList)

	'''
	   This method gets a list of all customers and returns it as a pretty html table
	   A 404 is thrown if the request does not have enough access
	'''
	def customers(self):
		cookie = request.cookies.get("FCS_GFB_Cookie")
		if(cookie == None):
			response.status_int = 404
			return
		else:
			creds = Cookie.decryptCookie(cookie)	
			if(creds.get('role') == '2') or (creds.get('role') == '1'):
				db = DB()
				customerList = db.getAllCustomers()
				return Sale.toTableMasterCustomerList(customerList);
			else:
				response.status_int = 404
				return 

	'''
	   This method gets a list of all donors and returns in a pretty html table
	   A 404 is thrown if the request does not have enough access
	'''
	def donors(self):
		cookie = request.cookies.get("FCS_GFB_Cookie")
		if(cookie == None):
			response.status_int = 404
			return
		else:
			creds = Cookie.decryptCookie(cookie)
			if (creds.get('role') == '1' or creds.get('role') == '2'):
				db = DB()
				donorList = db.getDonationOrders()			
				return Sale.toTableDonations(donorList);
			else:
				response.status_int = 404
				return

	def datesJSON(self):
		db = DB()
		if (request.method == "GET"):
			return json.dumps(db.getAllPickupDates())

	def dates(self):
		db = DB()	
		if (request.method == "GET"):
			if (request.params['dateID'] == '*'):
				dates = db.getDates()
				return Sale.toTableDates(dates, request.params['staticTable']);
			else:
				date = db.getDate(request.params['dateID'])
				return json.dumps(date)
		elif (request.method == "PUT"):
			#Edit Date
			if (request.params['dateID'] != '' and request.params['orderDate'] != ''and request.params['pickupDate'] != ''):
				success = db.updateDate(request.params['dateID'], request.params['pickupDate'], request.params['orderDate'])
				if success:
					return self.trueString
				else:
					return "{\"success\":\"false\",\"message\":\"Failed to enter new order.\"}"
 			elif (request.params['dateID'] == '' and request.params['orderDate'] != ''and request.params['pickupDate'] != ''):
 				#New Date
 				success = db.addNewDate(request.params['pickupDate'], request.params['orderDate'])
				if success:
					return self.trueString
				else:
					return "{\"success\":\"false\",\"message\":\"Failed to enter new order.\"}"
			#Delete Date
			else:
				success = db.deleteDate(request.params['dateID'])
				if success:
					return self.trueString
				else:
					return "{\"success\":\"false\",\"message\":\"Failed to enter new order.\"}"